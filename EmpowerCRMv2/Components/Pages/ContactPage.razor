@page "/contact/{Id:int}"
@rendermode InteractiveServer
@inject IContactService ContactService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<MudStack Row="true" Spacing="0">
    <MudIcon Icon="@Icons.Material.Filled.ContactPage" Color="Color.Primary" Size="Size.Large"></MudIcon>
    <MudText Typo="Typo.h5" Class="pt-1">Contact</MudText>
</MudStack>
<MudCard>
    <MudCardContent>
        @if (currentContact is not null)
        {
            <MudStack Row="true" Spacing="0">
                <MudText Heading="h3"><b>@currentContact.FirstName @currentContact.LastName</b></MudText>
                <MudSpacer />
                <MudButton Color="Color.Error">Delete</MudButton>
                <MudButton Color="Color.Primary">Edit</MudButton>
            </MudStack>
            <MudDivider DividerType="DividerType.FullWidth" Class="my-3" Light/>

            <MudStack Row="true" Spacing="3">
                <MudPaper>
                    <MudText Class="mx-2" Color="Color.Primary" Style="font-size: 12px;">Email</MudText>
                    <MudText Class="mx-3">@currentContact.Email</MudText>
                </MudPaper>
                <MudPaper>
                    <MudText Class="mx-2" Color="Color.Primary" Style="font-size: 12px;">Phone</MudText>
                    <MudText Class="mx-3">@currentContact.Phone</MudText>
                </MudPaper>
                <MudPaper>
                    <MudText Class="mx-2" Color="Color.Primary" Style="font-size: 12px;">Company</MudText>
                    <MudText Class="mx-3">@currentContact.Company</MudText>
                </MudPaper>
                <MudPaper>
                    <MudText Class="mx-2" Color="Color.Primary" Style="font-size: 12px;">Address</MudText>
                    <MudText Class="mx-3">@currentContact.Address</MudText>
                </MudPaper>
            </MudStack>
        }
        else
        {
            <MudText>Contact not found.</MudText>
        }
    </MudCardContent>
</MudCard>

@if (currentContact is not null && currentContact.Opportunities is not null)
{
    <MudGrid Class="my-4">
        <MudItem xs="6" md="8">
            <MudPaper>
                <MudStack Row="true" Spacing="0">
                    <MudIcon Icon="@Icons.Material.Filled.BusinessCenter" Color="Color.Primary" Size="Size.Medium" Class="pt=3"></MudIcon>
                    <MudText Typo="Typo.h6">Opportunities</MudText>
                </MudStack>
                <MudStack Wrap="Wrap.Wrap" Row="true">
                    @foreach (Opportunity opp in currentContact.Opportunities)
                    {
                        <MudPaper Height="200px" Width="380px" Class="ma-1 pa-1">
                            <MudText>@opp.Name</MudText>
                            <MudDivider DividerType="DividerType.FullWidth" Class="my-1" Light />
                            <MudPaper Class="ma-1">
                                <MudText Typo="Typo.h5" Color="Color.Primary">Amount</MudText>
                                <MudStack Row="true">
                                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Large"></MudIcon>
                                    <MudText Typo="Typo.h4" Color="Color.Success"><b>@opp.Amount 000000000</b></MudText>
                                </MudStack>
                            </MudPaper>
                            <MudPaper Class="ma-1">
                                <MudText Typo="Typo.h6" Color="Color.Primary">Stage</MudText>
                                <MudChip Size="Size.Large" Color="Color.Tertiary">@opp.Stage.Name</MudChip>
                            </MudPaper>
                        </MudPaper>
                    }
                    @foreach (Opportunity opp in currentContact.Opportunities)
                    {
                        <MudPaper Height="200px" Width="380px" Class="ma-1">
                            <MudText>@opp.Name</MudText>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" md="4">
            <MudPaper>
                <MudChart ChartType="ChartType.Donut" Width="300px" Height="300px" InputData="@opportunityAmounts" InputLabels="@opportunityNames">
                    <CustomGraphics>
                        <text class="donut-inner-text" x="47%" y="35%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="2">Total</text>
                        <text class="donut-inner-text" x="47%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="black" font-family="Helvetica" font-size="5">1000</text>
                    </CustomGraphics>
                </MudChart>
            </MudPaper>
        </MudItem>
    </MudGrid>
}
@code {
    [Parameter]
    public int Id { get; set; }

    public Contact currentContact { get; set; }
    public string?[] opportunityNames { get; set; }
    public double[] opportunityAmounts { get; set; }
    
    protected override async Task OnParametersSetAsync()
    {
        var contactItem = await ContactService.GetContactItemByIdAsync((int)Id);
        if (contactItem is not null)
        {
            currentContact = contactItem;
            opportunityNames = currentContact.Opportunities.Select(opportunity => opportunity.Name).ToArray();
            opportunityAmounts = currentContact.Opportunities.Select(opportunity => (double)opportunity.Amount).ToArray();

        }
    }
}
